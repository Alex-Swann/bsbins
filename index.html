<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stortford Bin Lookup</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 1rem; }
    #results { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Stortford Bin Collection Lookup</h1>

  <label>
    Postcode:
    <input type="text" id="postcode" placeholder="e.g. CM23 5HE">
  </label>

  <label>
    House Number:
    <input type="text" id="houseNumber" placeholder="e.g. 41">
  </label>

  <button id="lookupBtn">Check My Collection Dates</button>

  <div id="results"></div>

  <script>
    function normalizePostcode(input) {
        const cleaned = input.replace(/\s+/g, '').toUpperCase();
        if (cleaned.length < 5 || cleaned.length > 7) return cleaned; // fallback
        return `${cleaned.slice(0, -3)} ${cleaned.slice(-3)}`;
    }

    document.getElementById('lookupBtn').addEventListener('click', async () => {
      const rawPostcode = document.getElementById('postcode').value.trim();
      const postcode = normalizePostcode(rawPostcode);

      const houseNumber = document.getElementById('houseNumber').value.trim();
      const resultsEl = document.getElementById('results');

      resultsEl.innerHTML = '<p>Loading...</p>';

      try {
        // Step 1: Lookup addresses by postcode
        const addressRes = await fetch('api/search-addresses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postcode })
        });

        const { addresses } = await addressRes.json();

        if (!addresses || addresses.length === 0) {
          resultsEl.innerHTML = '<p>No addresses found for this postcode.</p>';
          return;
        }

        // Step 2: Find the one matching the house number
        const target = addresses.find(a => a.address.includes(`${houseNumber} `));
        if (!target) {
          resultsEl.innerHTML = '<p>Could not find that house number in the list of addresses.</p>';
          return;
        }

        // Step 3: Fetch bin collection info
        const detailsRes = await fetch('api/property-details', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uprn: target.uprn,
            address: target.address,
            propertyType: target.propertyType
          })
        });

        const details = await detailsRes.json();
        const collections = details.collections || [];

        // Step 4: Render
        if (collections.length === 0) {
          resultsEl.innerHTML = '<p>No collection data found for this address.</p>';
          return;
        }

        resultsEl.innerHTML = `
          <h2>Bin Collections for ${target.address}</h2>
          <ul>
            ${collections.map(c => `
              <li><strong>${c.serviceName}</strong> â€“ ${new Date(c.collectionDate).toLocaleDateString()} (Bin: ${c.binType})</li>
            `).join('')}
          </ul>
        `;
      } catch (error) {
        console.error(error);
        resultsEl.innerHTML = '<p>Something went wrong. Please try again.</p>';
      }
    });
  </script>
</body>
</html>
