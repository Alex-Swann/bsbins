<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bishop's Stortford New Bin Collection Lookup</title>
  <style>
    a {
        color: #2a649e;
    }
    .hint-text {
        color: grey;
        font-size: small;
        font-weight: bold;
        max-width: 400px;
        margin: 1rem auto;
        padding: 1rem 1.5rem;
    }
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #0057B8;  /* Blue color or choose your preferred */
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 0.5em;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .callout-box {
        max-width: 400px;        /* narrower than header */
        margin: 1rem auto;
        padding: 1rem 1.5rem;
        border: 2px solid #2a649e;
        border-radius: 8px;
        background-color: #f0f8ff;
        text-align: center;
        font-size: 1rem;
        color: #5b5858;
    }

    .callout-box p {
        margin: 0 0 0.5rem 0;
    }

    .callout-box a {
        color: #2a649e;
        font-weight: bold;
        text-decoration: none;
    }

    .callout-box a:hover,
    .callout-box a:focus {
     text-decoration: underline;
    }
   .bin-label {
        padding: 0.3em 0.6em;
        border-radius: 0.5em;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 0.4em;
        margin-right: 0.6em;       /* Added horizontal spacing */
        min-width: 160px;
        text-align: center;
    }

    .black {
        background-color: #000000;
        color: #FFFFFF;
    }
    .blue {
        background-color: #0057B8;
        color: #FFFFFF;
    }
    .purple {
        background-color: #6A0DAD;
        color: #FFFFFF;
    }
    .brown, .food {
        background-color: #8B4513;
        color: #FFFFFF;
    }
    .title {
        font-size: 2em;
        font-weight: bold;
        line-height: 1.2;
        text-align: center;
        margin-bottom: 1rem;
    }
    .title span {
        display: block; /* forces new line */
        font-weight: normal;
        font-size: 1.2em;
        margin-top: 0.1em;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 1rem auto;
      padding: 0 1rem;
      background: #f9f9f9;
      color: #222;
      text-align: center;  /* Center entire page content */
    }
    label {
      display: block;
      margin: 0.5rem auto 0.25rem;  /* Center label horizontally */
      max-width: 400px;
      text-align: left;
    }
    input#postcode,
    input#housenumber {
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      font-size: 1rem;
      padding: 0.4rem 0.5rem;
      margin: 0 auto 0.5rem;  /* Center inputs */
      display: block;
    }
    button {
      padding: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      max-width: 400px;
      width: 100%;
      margin: 0.75rem auto 1rem;  /* Center button */
      display: block;
    }
    #results p,
    #results ul {
      margin-top: 1rem;
      text-align: left;  /* Align results text left for readability */
    }

    /* Week container */
    .week {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      margin-bottom: 2rem;      /* gap between weeks */
      padding: 1rem 1.5rem;
      width: 66%;               /* two thirds width */
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
    .week-number {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #444;
    }
    /* Container for bins under each week */
    .bins-container {
      margin-left: 0;
    }

    @media (max-width: 400px) {
      body {
        padding: 0 0.5rem;
        text-align: left;  /* revert on small screens */
      }
      label {
        max-width: 100%;
        margin-left: 0;
      }
      input#postcode,
      input#housenumber,
      button {
        max-width: 100%;
        width: 100%;
        margin-left: 0;
      }
      button {
        font-size: 1.1rem;
      }
      .week {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1 class="title">
    Bishop's Stortford <span>New Bin Collection Lookup</span>
  </h1>
  <p class="hint-text">Planned update on 7-8th August</br>by bin contractor Veolia in regards to collection times.</p>
  <label for="postcode">Postcode</label>
  <input id="postcode" type="text" placeholder="e.g. CM23 5HE or CM235HE" />

  <label for="housenumber">House Number</label>
  <input id="housenumber" type="text" placeholder="e.g. 41" />

  <button id="getCollections">Get Bin Collections</button>

  <div id="results"></div>
    <div class="callout-box">
    <p>
        If there are any issues with this service, as it is free and casually managed,
        please refer to the following link:
    </p>
    <a href="https://www.eastherts.gov.uk/bins-waste-and-recycling/find-your-bin-collection-day" target="_blank" rel="noopener noreferrer">
        East Herts Council Bin Collection Information
    </a>
    </div>
<script>
  const apiSearch = '/api/search-addresses';
  const apiDetails = '/api/property-details';

  const postcodeInput = document.getElementById('postcode');
  const houseNumberInput = document.getElementById('housenumber');
  const getCollectionsBtn = document.getElementById('getCollections');
  const resultsDiv = document.getElementById('results');

  const cache = new Map(); // Cache key: postcode + house number

  function normalizePostcode(pc) {
    let p = pc.toUpperCase().replace(/\s+/g, '');
    if (p.length > 3) {
      return p.slice(0, -3) + ' ' + p.slice(-3);
    }
    return p;
  }

  const baselineDate = new Date('2025-08-04T00:00:00Z');

  const binCycle = [
    ['black', 'brown', 'food'],
    ['blue', 'food'],
    ['purple', 'brown', 'food'],
    ['black', 'food'],
    ['blue', 'brown', 'food'],
    ['purple', 'food']
  ];

  function formatDate(date) {
    const day = date.getDate();
    let suffix = 'th';
    if (day === 1 || day === 21 || day === 31) suffix = 'st';
    else if (day === 2 || day === 22) suffix = 'nd';
    else if (day === 3 || day === 23) suffix = 'rd';

    const weekday = date.toLocaleDateString(undefined, { weekday: 'long' });
    const month = date.toLocaleDateString(undefined, { month: 'long' });
    return `${weekday} ${day}${suffix} ${month}`;
  }

  function getWeekIndex(date) {
    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
    const diff = date - baselineDate;
    return diff < 0 ? 0 : Math.floor(diff / msPerWeek);
  }

  function clearChildren(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay(); // 0 (Sun) - 6 (Sat)
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
  return new Date(d.setDate(diff));
}

function formatDate(date) {
  return date.toLocaleDateString('en-GB', {
    weekday: 'long',
    day: 'numeric',
    month: 'long'
  });
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}



function renderCollections(startDate, collections) {
  clearChildren(resultsDiv);

  const today = new Date();

  // Group collections by ISO week starting Monday
  const groupedByWeek = {};
  const baselineDate = new Date(startDate);

  collections
    .filter(col => new Date(col.collectionDate) >= baselineDate)
    .forEach(col => {
        const colDate = new Date(col.collectionDate);
        const weekStart = new Date(colDate);
        const day = colDate.getDay();
        const diff = (day === 0 ? -6 : 1) - day; // shift so Monday is start
        weekStart.setDate(colDate.getDate() + diff);
        weekStart.setHours(0, 0, 0, 0);

        const key = weekStart.toISOString();
        if (!groupedByWeek[key]) {
        groupedByWeek[key] = {
            date: new Date(weekStart),
            collections: []
        };
        }

        groupedByWeek[key].collections.push(col);
    });

  const sortedWeeks = Object.values(groupedByWeek).sort((a, b) => a.date - b.date);

  for (let i = 0; i < Math.min(6, sortedWeeks.length); i++) {
    const week = sortedWeeks[i];

    const weekDiv = document.createElement('div');
    weekDiv.classList.add('week');

    const weekNumberHeading = document.createElement('h3');
    weekNumberHeading.classList.add('week-number');

    const weekLabel = formatDate(week.date); // e.g., Monday 4 August
    if (today < baselineDate) {
      weekNumberHeading.textContent = i === 0
        ? `Next Week`
        : `Week ${i + 1}`;
    } else {
      weekNumberHeading.textContent = i === 0
        ? `Current Week`
        : `Week ${i + 1}`;
    }

    weekDiv.appendChild(weekNumberHeading);

    // Group that week's collections by actual day
    const byDay = {};
    week.collections.forEach(col => {
      const colDate = new Date(col.collectionDate);
      const key = colDate.toDateString();
      if (!byDay[key]) {
        byDay[key] = {
          date: colDate,
          bins: []
        };
      }
      byDay[key].bins.push(col);
    });

    const sortedDays = Object.values(byDay).sort((a, b) => a.date - b.date);

    sortedDays.forEach(dayGroup => {
      const dayBox = document.createElement('div');
      dayBox.classList.add('callout-box');

      const dayHeading = document.createElement('h3');
      const options = { weekday: 'long', day: 'numeric', month: 'long' };
      dayHeading.textContent = `${dayGroup.date.toLocaleDateString(undefined, options)}`;
      dayBox.appendChild(dayHeading);

      dayGroup.bins.forEach(bin => {
        let material = '';
        switch (bin.binType.toLowerCase()) {
          case 'black': material = 'Mixed Recycling'; break;
          case 'blue': material = 'Paper/Cardboard'; break;
          case 'purple': material = 'Refuse/Non-Recycling'; break;
          case 'brown': material = 'Garden Waste'; break;
          case 'food': material = 'Food/Compost'; break;
          default: material = bin.serviceName || bin.binType; break;
        }

        const binLine = document.createElement('div');
        binLine.textContent = `${bin.binType.charAt(0).toUpperCase() + bin.binType.slice(1)} (${material})`;
        binLine.classList.add(bin.binType.toLowerCase(), 'bin-label');
        dayBox.appendChild(binLine);
      });

      weekDiv.appendChild(dayBox);
    });

    resultsDiv.appendChild(weekDiv);
  }
}


  async function fetchCollections(postcode, houseNumber) {
    const cacheKey = postcode + '|' + houseNumber;
    if (cache.has(cacheKey)) {
      return cache.get(cacheKey);
    }

    const searchResp = await fetch(apiSearch, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ postcode })
    });

    const searchData = await searchResp.json();

    if (!searchData.addresses || searchData.addresses.length === 0) {
      throw new Error('No addresses found for that postcode.');
    }

    const address = searchData.addresses.find(a =>
      a.address.toLowerCase().includes(houseNumber.toLowerCase())
    );

    if (!address) {
      throw new Error('House number not found for that postcode.');
    }

    const detailsResp = await fetch(apiDetails, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uprn: address.uprn,
        address: address.address,
        propertyType: address.propertyType
      })
    });

    const detailsData = await detailsResp.json();
    if (!detailsData.collections) {
      throw new Error('No collection data available for this address.');
    }

    cache.set(cacheKey, detailsData.collections);
    return detailsData.collections;
  }

  getCollectionsBtn.addEventListener('click', async () => {
    resultsDiv.innerHTML = '<span class="spinner"></span> Loading...';
    const rawPostcode = postcodeInput.value.trim();
    const rawHouseNumber = houseNumberInput.value.trim();

    if (!rawPostcode || !rawHouseNumber) {
      resultsDiv.textContent = 'Please enter both postcode and house number.';
      return;
    }

    const postcode = normalizePostcode(rawPostcode);

    try {
      const collections = await fetchCollections(postcode, rawHouseNumber);
      const today = new Date();
      const startDate = today < baselineDate ? baselineDate : today;
      renderCollections(startDate, collections);
    } catch (error) {
      resultsDiv.textContent = error.message || 'Error fetching data. Please try again later.';
    }
  });

  postcodeInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        getCollectionsBtn.click();
    }
    });

    houseNumberInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        getCollectionsBtn.click();
    }
    });
</script>
<footer><p><a href="privacy.html">Privacy Policy</a></p></footer>
</body>
</html>
