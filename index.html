<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bishop's Stortford New Bin Collection Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 1rem auto;
      padding: 0 1rem;
    }
    label, input, button {
      display: block;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    input#postcode,
    input#housenumber {
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      font-size: 1rem;
      padding: 0.4rem 0.5rem;
    }
    button {
      padding: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      max-width: 400px;
    }
    #results p,
    #results ul {
      margin-top: 1rem;
    }
    @media (max-width: 400px) {
      body {
        padding: 0 0.5rem;
      }
      input#postcode,
      input#housenumber,
      button {
        max-width: 100%;
        width: 100%;
      }
      button {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <h1>Bishop's Stortford New Bin Collection Lookup</h1>
  <label for="postcode">Postcode</label>
  <input id="postcode" type="text" placeholder="e.g. CM23 5HE or CM235HE" />

  <label for="housenumber">House Number</label>
  <input id="housenumber" type="text" placeholder="e.g. 41" />

  <button id="getCollections">Get Bin Collections</button>

  <div id="results"></div>

<script>
  const apiSearch = '/api/search-addresses';
  const apiDetails = '/api/property-details';

  const postcodeInput = document.getElementById('postcode');
  const houseNumberInput = document.getElementById('housenumber');
  const getCollectionsBtn = document.getElementById('getCollections');
  const resultsDiv = document.getElementById('results');

  const cache = new Map(); // Cache key: postcode + house number

  function normalizePostcode(pc) {
    let p = pc.toUpperCase().replace(/\s+/g, '');
    if (p.length > 3) {
      return p.slice(0, -3) + ' ' + p.slice(-3);
    }
    return p;
  }

  const baselineDate = new Date('2025-08-04T00:00:00Z');

  const binCycle = [
    ['black', 'brown', 'food'],
    ['blue', 'food'],
    ['purple', 'brown', 'food'],
    ['black', 'food'],
    ['blue', 'brown', 'food'],
    ['purple', 'food']
  ];

  function formatDate(date) {
    const day = date.getDate();
    let suffix = 'th';
    if (day === 1 || day === 21 || day === 31) suffix = 'st';
    else if (day === 2 || day === 22) suffix = 'nd';
    else if (day === 3 || day === 23) suffix = 'rd';

    const weekday = date.toLocaleDateString(undefined, { weekday: 'long' });
    const month = date.toLocaleDateString(undefined, { month: 'long' });
    return `${weekday} ${day}${suffix} ${month}`;
  }

  function getWeekIndex(date) {
    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
    const diff = date - baselineDate;
    return diff < 0 ? 0 : Math.floor(diff / msPerWeek);
  }

  function clearChildren(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  function renderCollections(startDate, collections) {
    clearChildren(resultsDiv);

    const startWeek = getWeekIndex(startDate);

    const pIntro = document.createElement('p');
    pIntro.textContent = `Your next collection week commencing ${formatDate(startDate)}:`;
    resultsDiv.appendChild(pIntro);

    const ul = document.createElement('ul');

    for (let i = 0; i < 6; i++) {
      const weekIndex = (startWeek + i) % binCycle.length;
      const weekDate = new Date(startDate.getTime() + i * 7 * 24 * 60 * 60 * 1000);
      const binsThisWeek = [];

      binCycle[weekIndex].forEach(binType => {
        const found = collections.find(c => c.binType.toLowerCase() === binType);
        if (found) {
          let material = '';
          switch (binType) {
            case 'black': material = 'Refuse'; break;
            case 'blue': material = 'Paper/Card'; break;
            case 'purple': material = 'Recycling'; break;
            case 'brown': material = 'Garden Waste'; break;
            case 'food': material = 'Food/Compost'; break;
            default: material = found.serviceName || binType; break;
          }
          binsThisWeek.push(`${binType.charAt(0).toUpperCase() + binType.slice(1)} (${material})`);
        }
      });

      if (binsThisWeek.length === 0) binsThisWeek.push('No collection');

      const li = document.createElement('li');
      li.innerHTML = `<strong>Week ${i + 1} (${formatDate(weekDate)}):</strong> ${binsThisWeek.join(', ')}`;
      ul.appendChild(li);
    }
    resultsDiv.appendChild(ul);
  }

  async function fetchCollections(postcode, houseNumber) {
    const cacheKey = postcode + '|' + houseNumber;
    if (cache.has(cacheKey)) {
      return cache.get(cacheKey);
    }

    const searchResp = await fetch(apiSearch, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ postcode })
    });

    const searchData = await searchResp.json();

    if (!searchData.addresses || searchData.addresses.length === 0) {
      throw new Error('No addresses found for that postcode.');
    }

    const address = searchData.addresses.find(a =>
      a.address.toLowerCase().includes(houseNumber.toLowerCase())
    );

    if (!address) {
      throw new Error('House number not found for that postcode.');
    }

    const detailsResp = await fetch(apiDetails, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uprn: address.uprn,
        address: address.address,
        propertyType: address.propertyType
      })
    });

    const detailsData = await detailsResp.json();

    if (!detailsData.collections) {
      throw new Error('No collection data available for this address.');
    }

    cache.set(cacheKey, detailsData.collections);
    return detailsData.collections;
  }

  getCollectionsBtn.addEventListener('click', async () => {
    resultsDiv.textContent = 'Loading...';
    const rawPostcode = postcodeInput.value.trim();
    const rawHouseNumber = houseNumberInput.value.trim();

    if (!rawPostcode || !rawHouseNumber) {
      resultsDiv.textContent = 'Please enter both postcode and house number.';
      return;
    }

    const postcode = normalizePostcode(rawPostcode);

    try {
      const collections = await fetchCollections(postcode, rawHouseNumber);
      const today = new Date();
      const startDate = today < baselineDate ? baselineDate : today;
      renderCollections(startDate, collections);
    } catch (error) {
      resultsDiv.textContent = error.message || 'Error fetching data. Please try again later.';
    }
  });
</script>
</body>
</html>
